---
- name: Check if Elastic Agent service exists (Windows)
  ansible.windows.win_service_info:
    name: Elastic Agent
  register: win_agent_service
  failed_when: false

- name: Uninstall Elastic Agent (Windows)
  block:
    - name: Stop Elastic Agent service if running
      ansible.windows.win_service:
        name: "Elastic Agent"
        state: stopped
      ignore_errors: yes

    - name: Uninstall Elastic Agent (non-interactive)
      win_shell: |
        & "C:\\Program Files\\Elastic\\Agent\\elastic-agent.exe" uninstall --force
      register: uninstall_result
      failed_when: false
      changed_when: "'non-zero return code' not in uninstall_result.stderr"

    - name: Debug uninstall output
      debug:
        var: uninstall_result

    - name: Include fallback cleanup if uninstall failed or crashed
      when: uninstall_result.rc != 0
      include_tasks: "tasks/cleanup-elastic-agent.yml"

    - name: Verify Elastic Agent is gone
      win_shell: |
        $svc = Get-Service -Name "Elastic Agent" -ErrorAction SilentlyContinue
        if ($svc) {
          Write-Output "Elastic Agent service still present"
          exit 1
        } else {
          Write-Output "Elastic Agent successfully removed"
        }
      register: verify_result
      failed_when: verify_result.rc != 0

    - debug:
        msg: "{{ verify_result.stdout }}"
  when: win_agent_service.exists

- name: Create install directory (Windows)
  ansible.windows.win_file:
    path: "{{ install_dir }}"
    state: directory

- name: Download locally Elastic Agent ZIP (Windows)
  get_url:
    url: "https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-{{ elastic_agent_version }}-windows-x86_64.zip"
    dest: "/tmp/elastic-agent.zip"
    mode: '0644'
  delegate_to: localhost
  run_once: true

- name: Copy Elastic Agent to Windows host
  win_copy:
    src: "/tmp/elastic-agent.zip"
    dest: "C:\\Windows\\Temp\\elastic-agent.zip"

- name: Extract Elastic Agent (Windows)
  win_unzip:
    src: "C:\\Windows\\Temp\\elastic-agent.zip"
    dest: "{{ install_dir }}"
    overwrite: yes

- name: Install Elastic Agent as service (Windows)
  win_shell: |
    cd "{{ install_dir }}\\elastic-agent-{{ elastic_agent_version }}-windows-x86_64"
    .\\elastic-agent.exe install --url={{ fleet_server_url }} --enrollment-token={{ enrollment_token }} --non-interactive --insecure
  args:
    executable: powershell

- name: Delete locally Elastic Agent ZIP after extraction (Windows)
  delegate_to: localhost
  run_once: true
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/tmp/elastic-agent.zip"

- name: Delete Elastic Agent ZIP after extraction (Windows)
  ansible.windows.win_file:
    path: "{{ item }}"
    state: absent
  loop:
    - "C:\\Windows\\Temp\\elastic-agent.zip"

- name: Ensure Elastic Agent service is started and enabled (Windows)
  ansible.windows.win_service:
    name: Elastic Agent
    state: started
    start_mode: auto
